<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>MoQT Debug Page</title>
	<style>
		body {
			font-family: system-ui, -apple-system, sans-serif;
			max-width: 800px;
			margin: 40px auto;
			padding: 20px;
			background: #f5f5f5;
		}
		.test-section {
			background: white;
			padding: 20px;
			margin: 20px 0;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
		.status {
			padding: 10px;
			margin: 10px 0;
			border-radius: 4px;
		}
		.success { background: #d4edda; color: #155724; }
		.error { background: #f8d7da; color: #721c24; }
		.info { background: #d1ecf1; color: #0c5460; }
		pre {
			background: #f8f9fa;
			padding: 10px;
			border-radius: 4px;
			overflow-x: auto;
		}
	</style>
</head>
<body>
	<h1>MoQT Deployment Debug</h1>
	
	<div class="test-section">
		<h2>Environment Info</h2>
		<div id="envInfo"></div>
	</div>

	<div class="test-section">
		<h2>Script Loading Tests</h2>
		<div id="scriptTests"></div>
	</div>

	<div class="test-section">
		<h2>Custom Elements Test</h2>
		<div id="customElementsTest"></div>
	</div>

	<div class="test-section">
		<h2>WebTransport Support</h2>
		<div id="webTransportTest"></div>
	</div>

	<div class="test-section">
		<h2>Console Logs</h2>
		<pre id="consoleLogs"></pre>
	</div>

	<script src="config.js"></script>
	<script src="./lib/moq-player.iife.js"></script>
	
	<script>
		// Capture console logs
		const logs = [];
		const originalLog = console.log;
		const originalError = console.error;
		const originalWarn = console.warn;

		console.log = function(...args) {
			logs.push(['LOG', ...args]);
			originalLog.apply(console, args);
			updateConsoleLogs();
		};
		console.error = function(...args) {
			logs.push(['ERROR', ...args]);
			originalError.apply(console, args);
			updateConsoleLogs();
		};
		console.warn = function(...args) {
			logs.push(['WARN', ...args]);
			originalWarn.apply(console, args);
			updateConsoleLogs();
		};

		function updateConsoleLogs() {
			const logsEl = document.getElementById('consoleLogs');
			logsEl.textContent = logs.map(log => log.join(' ')).join('\n');
		}

		function addStatus(containerId, message, type = 'info') {
			const container = document.getElementById(containerId);
			const div = document.createElement('div');
			div.className = `status ${type}`;
			div.textContent = message;
			container.appendChild(div);
		}

		// Environment Info
		function checkEnvironment() {
			const info = {
				'User Agent': navigator.userAgent,
				'Protocol': window.location.protocol,
				'Hostname': window.location.hostname,
				'Port': window.location.port || '(default)',
				'Pathname': window.location.pathname,
			};

			const container = document.getElementById('envInfo');
			for (const [key, value] of Object.entries(info)) {
				const div = document.createElement('div');
				div.innerHTML = `<strong>${key}:</strong> ${value}`;
				container.appendChild(div);
			}
		}

		// Script Loading Tests
		function checkScripts() {
			// Check if config loaded
			if (typeof window.MoQConfig !== 'undefined') {
				addStatus('scriptTests', '✓ config.js loaded successfully', 'success');
				addStatus('scriptTests', `Relay: ${window.MoQConfig.getRelayUrl()}`, 'info');
			} else {
				addStatus('scriptTests', '✗ config.js failed to load', 'error');
			}

			// Check if MoqPlayer loaded
			if (typeof window.MoqPlayer !== 'undefined') {
				addStatus('scriptTests', '✓ moq-player.iife.js loaded successfully', 'success');
			} else {
				addStatus('scriptTests', '✗ moq-player.iife.js failed to load', 'error');
			}
		}

		// Custom Elements Test
		async function checkCustomElements() {
			try {
				console.log('Checking for video-moq custom element...');
				
				// Check if already defined
				const isDefined = customElements.get('video-moq');
				if (isDefined) {
					addStatus('customElementsTest', '✓ video-moq element already defined', 'success');
					return;
				}

				// Wait for it to be defined
				addStatus('customElementsTest', 'Waiting for video-moq to be defined...', 'info');
				
				const timeout = new Promise((_, reject) => 
					setTimeout(() => reject(new Error('Timeout after 5 seconds')), 5000)
				);

				await Promise.race([
					customElements.whenDefined('video-moq'),
					timeout
				]);

				addStatus('customElementsTest', '✓ video-moq element defined successfully', 'success');
				
				// Try to create an instance
				const testElement = document.createElement('video-moq');
				addStatus('customElementsTest', `✓ Created test element: ${testElement.tagName}`, 'success');
				
			} catch (error) {
				addStatus('customElementsTest', `✗ Error: ${error.message}`, 'error');
				console.error('Custom element check failed:', error);
			}
		}

		// WebTransport Support
		function checkWebTransport() {
			if ('WebTransport' in window) {
				addStatus('webTransportTest', '✓ WebTransport API is supported', 'success');
			} else {
				addStatus('webTransportTest', '✗ WebTransport API is NOT supported', 'error');
				addStatus('webTransportTest', 'This browser does not support WebTransport. Chrome 97+ or Edge 97+ required.', 'error');
			}

			// Check for SharedArrayBuffer (required for some features)
			if (typeof SharedArrayBuffer !== 'undefined') {
				addStatus('webTransportTest', '✓ SharedArrayBuffer is available', 'success');
			} else {
				addStatus('webTransportTest', '✗ SharedArrayBuffer is NOT available', 'error');
				addStatus('webTransportTest', 'Check Cross-Origin-Opener-Policy and Cross-Origin-Embedder-Policy headers', 'info');
			}
		}

		// Run all tests
		document.addEventListener('DOMContentLoaded', async () => {
			console.log('Debug page loaded');
			
			checkEnvironment();
			
			// Wait a bit for scripts to load
			setTimeout(async () => {
				checkScripts();
				await checkCustomElements();
				checkWebTransport();
			}, 100);
		});
	</script>
</body>
</html>

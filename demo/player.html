<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>MoQT Demo - Player</title>
		<link rel="stylesheet" href="style.css" />
	</head>
	<body>
		<div class="container">
			<header class="header">
				<h1>MoQT Video Player</h1>
				<p class="subtitle">Ultra-low latency streaming viewer</p>
			</header>

			<main class="main-content">
				<div class="player-section">
					<div id="errorMessage" class="error-message" style="display: none">
						<h3>⚠️ Stream Not Available</h3>
						<p id="errorText"></p>
						<a href="index.html" class="btn btn-primary">Start Your Own Stream</a>
					</div>

					<div id="playerContainer" class="player-container">
						<div class="video-wrapper" id="videoWrapper">
							<!-- video-moq element will be created dynamically -->
						</div>

						<div id="connectionStatus" class="status-indicator">
							<span class="status-dot"></span>
							<span class="status-text">Connecting...</span>
						</div>

						<div class="player-controls">
							<button id="reconnectBtn" class="btn btn-secondary" style="display: none">Reconnect</button>
							<button id="fullscreenBtn" class="btn btn-secondary">Fullscreen</button>
						</div>
					</div>
				</div>

				<div class="stream-info">
					<h3>Stream Information</h3>
					<div class="info-grid">
						<div class="info-item">
							<label>Namespace:</label>
							<span id="streamNamespace">-</span>
						</div>
						<div class="info-item">
							<label>Relay:</label>
							<span id="streamRelay">-</span>
						</div>
						<div class="info-item">
							<label>Status:</label>
							<span id="streamStatus">Initializing</span>
						</div>
					</div>
				</div>

				<div class="actions-section">
					<h3>Actions</h3>
					<div class="action-buttons">
						<button id="shareBtn" class="btn btn-secondary">Share This Stream</button>
						<a href="index.html" class="btn btn-primary">Start Your Own Stream</a>
					</div>
				</div>

				<div class="help-section">
					<details>
						<summary>Troubleshooting</summary>
						<div class="help-content">
							<h4>Stream not loading?</h4>
							<ul>
								<li>Check that the stream is still active on the publisher side</li>
								<li>Ensure your browser supports WebTransport (Chrome 97+, Edge 97+)</li>
								<li>Try refreshing the page or reconnecting</li>
								<li>Check your network connection</li>
							</ul>
						</div>
					</details>
				</div>
			</main>

			<footer class="footer">
				<p>
					Powered by
					<a href="https://datatracker.ietf.org/wg/moq/about/" target="_blank">MoQT Protocol</a>
				</p>
			</footer>
		</div>

		<!-- Load configuration first -->
		<script src="config.js" onerror="console.error('Failed to load config.js')"></script>

		<!-- Load MoQ player library with video-moq custom element -->
		<script src="./lib/moq-player.iife.js" 
			onerror="console.error('Failed to load moq-player.iife.js')"
			onload="console.log('moq-player.iife.js loaded successfully')">
		</script>

		<!-- Player page logic -->
		<script>
			class MoQTPlayerDemo {
				constructor() {
					console.log("MoQTPlayerDemo constructor");
					this.namespace = null;
					this.isConnected = false;
					this.videoPlayer = null;
					this.startTime = Date.now();

					this.initializeElements();
					this.setupEventListeners();
					this.parseUrlParameters();
					this.updateConfigDisplay();
					this.initializePlayer();
				}

				initializeElements() {
					console.log("MoQTPlayerDemo initializeElements");
					this.errorMessage = document.getElementById("errorMessage");
					this.errorText = document.getElementById("errorText");
					this.playerContainer = document.getElementById("playerContainer");
					this.videoWrapper = document.getElementById("videoWrapper");
					this.videoPlayer = null; // Will be created dynamically
					this.connectionStatus = document.getElementById("connectionStatus");
					this.reconnectBtn = document.getElementById("reconnectBtn");
					this.fullscreenBtn = document.getElementById("fullscreenBtn");
					this.shareBtn = document.getElementById("shareBtn");

					// Info elements
					this.streamNamespace = document.getElementById("streamNamespace");
					this.streamRelay = document.getElementById("streamRelay");
					this.streamStatus = document.getElementById("streamStatus");
				}

				setupEventListeners() {
					console.log("MoQTPlayerDemo setupEventListeners");
					this.reconnectBtn.addEventListener("click", () => this.reconnect());
					this.fullscreenBtn.addEventListener("click", () => this.toggleFullscreen());
					this.shareBtn.addEventListener("click", () => this.shareStream());
				}

				setupVideoEventListeners() {
					console.log("MoQTPlayerDemo setupVideoEventListeners");
					// Video player events - called after video element is created
					if (this.videoPlayer) {
						this.videoPlayer.addEventListener("connected", () => {
							console.log("Video player 'connected' event fired");
							this.onConnected();
						});
						this.videoPlayer.addEventListener("disconnected", () => {
							console.log("Video player 'disconnected' event fired");
							this.onDisconnected();
						});
						this.videoPlayer.addEventListener("error", (e) => {
							console.log("Video player 'error' event fired:", e);
							this.onError(e);
						});

						// Fallback: detect connection by checking if video is playing
						this.videoPlayer.addEventListener("play", () => {
							console.log("Video 'play' event fired, isConnected:", this.isConnected);
							if (!this.isConnected) {
								this.onConnected();
							}
						});

						this.videoPlayer.addEventListener("loadstart", () => {
							console.log("Video 'loadstart' event fired");
							if (!this.isConnected) {
								this.updateStatus("Loading stream...", false);
							}
						});

						this.videoPlayer.addEventListener("canplay", () => {
							console.log("Video 'canplay' event fired, isConnected:", this.isConnected);
							if (!this.isConnected) {
								this.onConnected();
							}
						});

						this.videoPlayer.addEventListener("loadeddata", () => {
							console.log("Video 'loadeddata' event fired, isConnected:", this.isConnected);
							if (!this.isConnected) {
								this.onConnected();
							}
						});

						this.videoPlayer.addEventListener("timeupdate", () => {
							// Only log once to avoid spam
							if (!this.isConnected && !this.timeUpdateLogged) {
								console.log("Video 'timeupdate' event fired - video is playing");
								this.timeUpdateLogged = true;
								this.onConnected();
							}
						});
					}
				}

				parseUrlParameters() {
					const urlParams = new URLSearchParams(window.location.search);
					this.namespace = urlParams.get("namespace");

					if (!this.namespace) {
						this.showError("No stream namespace provided in URL. Please use a valid player link.");
						return;
					}

					// Accept any namespace format - let the component handle validation
				}

				updateConfigDisplay() {
					this.streamNamespace.textContent = this.namespace || "Not specified";
					this.streamRelay.textContent = window.MoQConfig.getRelayUrl();
				}

				async initializePlayer() {
					console.log("MoQTPlayerDemo initializePlayer");
					if (!this.namespace) {
						console.log("No namespace provided");
						return; // Error already shown
					}

					try {
						this.updateStatus("Connecting to stream...", false);
						console.log("MoQTPlayerDemo initializePlayer try");

						// Create video-moq element dynamically like dynamic-player example
						this.videoPlayer = document.createElement("video-moq");
						this.videoPlayer.id = "videoPlayer";
						this.videoPlayer.setAttribute("controls", "");
						this.videoPlayer.setAttribute("autoplay", "");
						this.videoPlayer.setAttribute("muted", "");

						// Configure the video player element with full URL
						const srcUrl = `${window.MoQConfig.getRelayUrl()}?namespace=${this.namespace}`;
						this.videoPlayer.setAttribute("src", srcUrl);
						console.log("MoQTPlayerDemo initializePlayer srcUrl", srcUrl);

						if (window.MoQConfig.getFingerprintUrl()) {
							this.videoPlayer.setAttribute("fingerprint", window.MoQConfig.getFingerprintUrl());
						}
						console.log(
							"MoQTPlayerDemo initializePlayer fingerprint",
							window.MoQConfig.getFingerprintUrl(),
						);

						// Add event listeners before appending to DOM
						this.setupVideoEventListeners();

						// Append to video wrapper
						this.videoWrapper.appendChild(this.videoPlayer);

						this.startConnectionStatusCheck();
					} catch (error) {
						console.error("Failed to initialize player:", error);
						this.showError(`Failed to connect to stream: ${error.message}`);
					}
				}

				showError(message) {
					this.errorText.textContent = message;
					this.errorMessage.style.display = "block";
					this.playerContainer.style.display = "none";
					this.streamStatus.textContent = "Error";
				}

				hideError() {
					this.errorMessage.style.display = "none";
					this.playerContainer.style.display = "block";
				}

				updateStatus(status, isConnected = false) {
					const statusText = this.connectionStatus.querySelector(".status-text");
					const statusDot = this.connectionStatus.querySelector(".status-dot");

					statusText.textContent = status;
					statusDot.className = `status-dot ${isConnected ? "connected" : "disconnected"}`;

					this.streamStatus.textContent = status;
					this.isConnected = isConnected;

					// Show/hide reconnect button
					this.reconnectBtn.style.display = isConnected ? "none" : "inline-block";
				}

				onConnected() {
					this.hideError();
					this.updateStatus("Connected - Streaming", true);
					console.log("Player connected to stream");
				}

				onDisconnected() {
					this.updateStatus("Disconnected", false);
					console.log("Player disconnected from stream");
				}

				onError(event) {
					console.error("Player error:", event.detail);
					this.updateStatus("Connection error", false);
					this.showError(`Stream error: ${event.detail.message || "Unknown error"}`);
				}

				async reconnect() {
					this.updateStatus("Reconnecting...", false);
					try {
						if (this.videoPlayer && this.videoWrapper) {
							// Remove existing player and recreate
							this.videoWrapper.removeChild(this.videoPlayer);
							await this.initializePlayer();
						}
					} catch (error) {
						console.error("Reconnection failed:", error);
						this.showError(`Reconnection failed: ${error.message}`);
					}
				}

				toggleFullscreen() {
					if (this.videoPlayer) {
						if (document.fullscreenElement) {
							document.exitFullscreen();
						} else {
							this.videoPlayer.requestFullscreen();
						}
					}
				}

				async shareStream() {
					const url = window.location.href;

					if (navigator.share) {
						try {
							await navigator.share({
								title: "MoQT Live Stream",
								text: "Watch this ultra-low latency live stream!",
								url: url,
							});
						} catch (error) {
							console.log("Share cancelled or failed:", error);
						}
					} else {
						// Fallback: copy to clipboard
						try {
							await navigator.clipboard.writeText(url);

							// Visual feedback
							const originalText = this.shareBtn.textContent;
							this.shareBtn.textContent = "Link Copied!";

							setTimeout(() => {
								this.shareBtn.textContent = originalText;
							}, 2000);
						} catch (error) {
							console.error("Failed to copy to clipboard:", error);
							alert("Copy this link to share: " + url);
						}
					}
				}

				startConnectionStatusCheck() {
					// Fallback check to detect if video is actually playing
					this.statusCheckInterval = setInterval(() => {
						if (!this.isConnected && this.videoPlayer) {
							// Check if video has duration and current time is progressing
							if (this.videoPlayer.duration > 0 && this.videoPlayer.currentTime > 0) {
								console.log(
									"Video detected as playing via periodic check - duration:",
									this.videoPlayer.duration,
									"currentTime:",
									this.videoPlayer.currentTime,
								);
								this.onConnected();
							}
							// Also check if video element has loaded data
							else if (this.videoPlayer.readyState >= 2) {
								// HAVE_CURRENT_DATA or higher
								console.log(
									"Video data loaded via periodic check - readyState:",
									this.videoPlayer.readyState,
								);
								this.onConnected();
							}
						}
					}, 1000);
				}

				destroy() {
					if (this.statusCheckInterval) {
						clearInterval(this.statusCheckInterval);
					}
				}
			}

			// Initialize the player when the page loads and custom element is ready
			async function initializeWhenReady() {
				console.log("Waiting for video-moq custom element to be defined...");
				console.log("MoqPlayer global available:", typeof window.MoqPlayer !== 'undefined');
				console.log("customElements registry:", customElements);

				try {
					// Wait for the custom element to be defined with a timeout
					const timeoutPromise = new Promise((_, reject) => 
						setTimeout(() => reject(new Error('Timeout waiting for video-moq element')), 10000)
					);
					
					await Promise.race([
						customElements.whenDefined("video-moq"),
						timeoutPromise
					]);
					
					console.log("video-moq custom element is now defined");

					// Now initialize the player
					window.playerDemo = new MoQTPlayerDemo();
				} catch (error) {
					console.error("Failed to initialize player:", error);
					
					// Show error to user
					const errorDiv = document.getElementById("errorMessage");
					const errorText = document.getElementById("errorText");
					if (errorDiv && errorText) {
						errorText.textContent = `Failed to load player: ${error.message}. Please refresh the page.`;
						errorDiv.style.display = "block";
						document.getElementById("playerContainer").style.display = "none";
					}
				}
			}

			document.addEventListener("DOMContentLoaded", async () => {
				console.log("DOMContentLoaded event fired");
				console.log("Document readyState:", document.readyState);
				console.log("Scripts loaded - checking globals...");
				console.log("window.MoQConfig:", window.MoQConfig);
				console.log("window.MoqPlayer:", window.MoqPlayer);
				
				await initializeWhenReady();
			});

			// Cleanup on page unload
			window.addEventListener("beforeunload", () => {
				if (window.playerDemo) {
					window.playerDemo.destroy();
				}
			});
		</script>
	</body>
</html>
